#!/bin/bash
set -o nounset -o pipefail -o errexit -o privileged
function usage {
cat <<USAGE
 USAGE: CAdir <directory>

  Perform CA operations (given on STDIN) on the directory.
USAGE
}

declare -A CAdir=( [--syslog]=true [root]="" )
while [[ "${1:-}" != "" ]]
do
  case "${1:-}" in
    -h|'-?'|--help) usage ; exit 0 ;;
    --syslog)       CAdir[--syslog]=true ;;
    --no-syslog)    CAdir[--syslog]=false ;;
    *)              CAdir[root]="$1" ;;
  esac
  shift
done


## Logging niceties.

function timestamp {
  date --utc +%FT%TZ
}
function syslog {
  if ${CAdir[--syslog]}
  then
    sed -r 's/^.{20} -CAdir- //' | logger -i -p user.info
  else
    cat > /dev/null
  fi
}
function lockedlog {
  flock --timeout 0.5 --exclusive ./CAdir/log tee ./CAdir/log 
}

function msg {
  printf "%s\n" -- "$(timestamp) -CAdir- $1"
}
function info {
  msg "$1"
}
function err {
  msg "$1"
  exit 1
}


function main {
  { [[ -n "${CAdir[root]}" ]] || err "No CA dir given."
    if cd "${CAdir[root]}" 2>&1
    then
      info "Changed directory to \`${CAdir[root]}'."
    else
      err "Failed to change directory to \`${CAdir[root]}'."
    fi
    [[ -d ./CAdir ]] || { info "Creating \`./CAdir/log'."
                          mkdir -p ./CAdir 2>&1           ;} 
    info "Locking \`./CAdir/log'."
    { info "User is \`$(whoami)'."
      wc -l 1>&2
      info "Finished."            ;} | lockedlog
    info "Unlocked."                                          ;} | syslog
}

main

